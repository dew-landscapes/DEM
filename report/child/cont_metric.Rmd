
```{r thisOne{{cont_metricID}}{{areaID}}}

  cont_metricID <- "{{cont_metricID}}"

```

### `r cont_metricID`

Figure \@ref(fig:raw{{cont_metricID}}{{areaID}}) shows rasters for `r cont_metricID` in the `r use_name` area.

Table \@ref(fig:contFig{{cont_metricID}}{{areaID}}) shows boxplots for each decile of `r cont_metricID`, allowing a comparison of values within each DEM across different ranges of `r cont_metricID`. Deciles are based on the values in the reference DEM: `r results_df$dem_name[results_df$aoi_id == areaID & results_df$is_ref]`.

Figure \@ref(fig:plot{{cont_metricID}}{{areaID}}) shows the a distribution of values for each sample DEM and window size.

Figure \@ref(fig:diffPlot{{cont_metricID}}{{areaID}}) shows the distribution of differences between the reference DEM and the other DEMs.

```{r raw{{cont_metricID}}{{areaID}}, fig.cap = paste0(cont_metricID, " raster for each DEM")}

z <- if(cont_metricID %in% terrain_metrics) t else q

z <- z[results_df$aoi_id == areaID]

dems <- terra::rast(purrr::map(z
                              , \(x) x[[cont_metricID]]
                              )
                   ) |>
  setNames(results_df$dem_name[results_df$aoi_id == areaID])

m <- tm_shape(dems) +
  tm_raster(col.scale = tm_scale_continuous()) +
  tm_facets(nrow = 2)

m <- tmap::tmap_leaflet(m)

class(m) <- c(class(m), "htmlwidget")

m
  
```

<br>

```{r contFig{{cont_metricID}}{{areaID}}, fig.cap = "Range of values within deciles for each DEM. Deciles are taken from the reference DEM"}

cont_area %>%
  dplyr::filter(metric == cont_metricID) %>%
  dplyr::select(!contains("plot")) %>%
  tidyr::unnest(cols = c(data)) %>%
  dplyr::select(aoi_name, dem_name, x, y, metric, value) %>%
  tidyr::pivot_wider(names_from = dem_name
                     , values_from = value
                     ) %>%
  dplyr::mutate(cut_class = cut(!!rlang::ensym(reference)
                                , breaks = quantile(!!rlang::ensym(reference)
                                                    , probs = seq(0, 1, 0.1)
                                                    , na.rm = TRUE
                                                    )
                                , include.lowest = TRUE
                                )
                ) %>%
  tidyr::pivot_longer(tidyselect::any_of(as.character(unique(results_df$dem_name)))
                      , names_to = "dem_name"
                      ) %>%
  dplyr::mutate(dem_name = forcats::fct_relevel(dem_name, unique(results_df$dem_name[results_df$is_ref]))) %>%
  ggplot(aes(value, cut_class, fill = cut_class)) +
    geom_boxplot() +
    facet_grid(~ dem_name
               , scales = "free_y"
               ) +
    scale_fill_viridis_d() +
    labs(title = cont_metricID
         , y = paste0(reference, " deciles")
         , fill = "deciles"
         ) +
    guides(fill = guide_legend(reverse = TRUE)) +
    theme(axis.text.y = element_blank())

  # ggplot(temp, aes(x = short
  #                  , xend = short
  #                  , y = q50
  #                  )
  #        ) +
  #   geom_segment(aes(y = q01
  #                    , yend = q99
  #                    )
  #                , size = 1
  #                , alpha = 0.5
  #                ) +
  #   geom_segment(aes(y = q10
  #                    , yend = q90
  #                    )
  #                , size = 2
  #                , alpha = 0.5
  #                ) +
  #   geom_segment(aes(y = q25
  #                    , yend = q75
  #                    )
  #                , size = 3
  #                , alpha = 0.5
  #                ) +
  #   geom_point(colour = "blue") +
  #   coord_flip() +
  #   facet_grid(results_df ~ .) +
  #   labs(title = cont_metricID
  #        , x = "value"
  #        , y = "Sample DEM"
  #        )

```

<br>

```{r plot{{cont_metricID}}{{areaID}}, fig.cap = paste0("Distribution of ", cont_metricID, " values in each DEM: ", use_name)}

cont_area |>
  dplyr::filter(metric == cont_metricID) |>
  tidyr::unnest(cols = c(data)) |>
  cont_plot(title = cont_metricID
            , prob = 0.00
            )

```

<br>

```{r diffPlot{{cont_metricID}}{{areaID}}, fig.cap = paste0("Distribution of difference between each DEM and reference for ", cont_metricID, " values: ", use_name)}

cont_area |>
  dplyr::filter(metric == cont_metricID) |>
  tidyr::unnest(cols = c(data)) |>
  cont_plot(title = cont_metricID
            , prob = 0.00
            , diff = TRUE
            )

```
